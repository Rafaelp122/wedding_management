# ADR-003: Por que Cloudflare R2?

**Status:** Aceito
**Data:** Janeiro 2025
**Decisor:** Rafael
**Contexto:** Escolha de object storage para contratos em PDF

---

## Contexto e Problema

Precisamos armazenar PDFs de contratos (2-5MB cada) com:

- Custo zero ou mínimo no MVP
- Upload direto do frontend (não via backend)
- Compatibilidade S3 (evitar vendor lock-in)
- **Zero egress cost** (download não cobra)

**Alternativas:**

1. **Cloudflare R2** (escolhido)
2. AWS S3
3. Google Cloud Storage
4. DigitalOcean Spaces

---

## Decisão

Escolhemos **Cloudflare R2** para armazenamento de contratos.

---

## Justificativa

### Comparação de Custos

Cenário: 100 contratos/mês, 2MB cada, 1000 downloads/mês

| Serviço | Storage     | Egress (Download) | Total/mês |
| ------- | ----------- | ----------------- | --------- |
| **R2**  | R$ 0 (10GB) | **R$ 0**          | **R$ 0**  |
| **S3**  | R$ 0 (5GB)  | R$ 1,80 (2GB)     | R$ 1,80   |
| **GCS** | R$ 0 (5GB)  | R$ 2,40 (2GB)     | R$ 2,40   |

**Diferencial:** R2 **não cobra egress** (S3 cobra USD 0,09/GB).

---

### Vantagens do R2

**1. Zero Egress Cost:**

```
100 contratos × 2MB = 200MB storage
1000 downloads/mês × 2MB = 2GB egress

R2: R$ 0
S3: USD 0,18/mês (~R$ 1)
```

**2. S3-Compatible API:**

```python
# Mesmo código boto3 funciona
import boto3

s3 = boto3.client(
    's3',
    endpoint_url='https://ACCOUNT_ID.r2.cloudflarestorage.com',
    aws_access_key_id=R2_ACCESS_KEY,
    aws_secret_access_key=R2_SECRET_KEY
)

# Métodos idênticos ao S3
s3.upload_file('contract.pdf', 'bucket', 'key')
s3.generate_presigned_url('get_object', Params={...})
```

**3. Free Tier:**

- 10GB storage/mês
- 10 milhões de operações (Class A)
- **Egress ilimitado** (R$ 0)

---

### Trade-offs Aceitos

**❌ CDN Separado (Cloudflare):**

- R2 não tem CDN integrado (S3 tem CloudFront)
- **Mitigação:** Cloudflare Workers (se necessário)

**❌ Menos Mature que S3:**

- Lançado em 2022 (S3 existe desde 2006)
- **Mitigação:** API S3-compatible = fácil migrar

---

## Configuração

```python
# settings.py
R2_ENDPOINT_URL = os.getenv('R2_ENDPOINT_URL')
R2_ACCESS_KEY_ID = os.getenv('R2_ACCESS_KEY_ID')
R2_SECRET_ACCESS_KEY = os.getenv('R2_SECRET_ACCESS_KEY')
R2_BUCKET = 'wedding-contracts'

# services.py
def generate_upload_url(filename: str, wedding_id: str) -> dict:
    object_key = f'contracts/{wedding_id}/{uuid.uuid4()}/{filename}'

    presigned_url = s3_client.generate_presigned_url(
        'put_object',
        Params={
            'Bucket': R2_BUCKET,
            'Key': object_key,
            'ContentType': 'application/pdf'
        },
        ExpiresIn=900  # 15 minutos
    )

    return {'upload_url': presigned_url, 'object_key': object_key}
```

---

## Consequências

### Positivas ✅

- **Zero egress cost** (economia significativa em escala)
- S3-compatible API (fácil migrar se necessário)
- Free tier generoso (10GB)

### Negativas ❌

- Menos features que S3 (sem lifecycle policies)
- Menos maduro (lançado 2022)

---

## Monitoramento

**Gatilhos de revisão:**

- Storage > 8GB (80% do free tier)
- Necessidade de CDN global
- Custo projetado > R$ 50/mês

---

## Referências

- [R2 Documentation](https://developers.cloudflare.com/r2/)
- [R2 Pricing](https://developers.cloudflare.com/r2/pricing/)
- [ADR-004: Presigned URLs](004-presigned-urls.md)
- [ARCHITECTURE.md](../ARCHITECTURE.md)

---

**Última atualização:** 8 de fevereiro de 2026
