{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        body { font-family: Helvetica, Arial, sans-serif; font-size: 11pt; line-height: 1.5; color: #333; }
        
        .header-container { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #9C27B0; padding-bottom: 20px; }
        .logo { width: 180px; height: auto; margin-bottom: 15px; }
        .title { font-size: 18pt; font-weight: bold; color: #000; text-transform: uppercase; }
        .subtitle { font-size: 12pt; color: #666; margin-top: 5px; }
        
        .summary-box {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        .value-highlight {
            font-size: 14pt;
            font-weight: bold;
            color: #2e7d32;
            text-align: right;
        }
        
        .section-title { font-weight: bold; font-size: 12pt; margin-top: 20px; margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px solid #eee; }
        .content { text-align: justify; margin-bottom: 30px; }
        .party-info { background: #fff; border: 1px solid #eee; padding: 10px; margin-bottom: 8px; border-left: 4px solid #9C27B0; font-size: 10pt; }
        
        .signatures-table { width: 100%; margin-top: 40px; border-collapse: collapse; page-break-inside: avoid; }
        .signatures-table td { width: 33%; vertical-align: top; padding: 5px; text-align: center; }
        .sig-box { border: 1px solid #ddd; padding: 10px; height: 160px; position: relative; }
        .sig-img { max-width: 100%; max-height: 70px; margin-bottom: 5px; }
        .sig-line { border-top: 1px solid #000; margin-top: 10px; margin-bottom: 5px; width: 80%; margin-left: auto; margin-right: auto; }
        .sig-role { font-weight: bold; font-size: 8pt; color: #9C27B0; text-transform: uppercase; }
        .sig-name { font-size: 9pt; font-weight: bold; }
        .sig-meta { font-size: 7pt; color: #777; margin-top: 2px; }

        .footer-audit { 
            margin-top: 40px; 
            border-top: 1px dotted #ccc; 
            padding-top: 15px; 
            font-size: 8pt; 
            color: #999; 
            font-family: Courier, monospace;
            page-break-inside: avoid;
        }
        /* Layout para alinhar QR Code e Texto no rodapé */
        .footer-table { width: 100%; }
        .footer-text { text-align: left; vertical-align: middle; }
        .footer-qr { text-align: right; vertical-align: middle; width: 80px; }
    </style>
</head>
<body>

    <div class="header-container">
        <img src="{% static 'img/inline_logo.png' %}" class="logo">
        <div class="title">Contrato de Prestação de Serviços</div>
        <div class="subtitle">Evento: Casamento de {{ contract.wedding.bride_name }} & {{ contract.wedding.groom_name }}</div>
        <div class="subtitle">Data: {{ contract.wedding.date|date:"d \d\e F \d\e Y" }}</div>
    </div>

    <div class="summary-box">
        <table style="width: 100%;">
            <tr>
                <td style="vertical-align: middle;">
                    <strong>Item Contratado:</strong><br>
                    {{ contract.item.name }}
                </td>
                <td class="value-highlight">
                    Valor Total: R$ {{ contract.contract_value|floatformat:2 }}
                </td>
            </tr>
        </table>
    </div>

    <div class="content">
        <div class="section-title">1. Identificação das Partes</div>
        
        <div class="party-info">
            <strong>CONTRATANTE (NOIVOS):</strong> {{ contract.wedding.bride_name }} e {{ contract.wedding.groom_name }}
        </div>
        
        <div class="party-info">
            <strong>CONTRATADA (FORNECEDOR):</strong> {{ contract.item.supplier|default:"Fornecedor a definir" }}
        </div>

        <div class="party-info">
            <strong>INTERVENIENTE (CERIMONIALISTA):</strong> {{ contract.wedding.planner.get_full_name|default:contract.wedding.planner.username }}
        </div>
        
        <div class="section-title">2. Objeto e Detalhamento</div>
        <p>
            Este contrato formaliza a prestação de serviços de <strong>{{ contract.item.name }}</strong> para o evento supracitado.
        </p>
        <p style="background: #fff; padding: 15px; border: 1px solid #eee; font-style: italic;">
            {{ contract.description|default:"(Descrição detalhada dos serviços conforme proposta...)"|linebreaks }}
        </p>
        
        <div class="section-title">3. Condições de Pagamento</div>
        <p>
            O valor total de <strong>R$ {{ contract.contract_value|floatformat:2 }}</strong> segue as condições de pagamento estabelecidas.
        </p>
    </div>

    <table class="signatures-table">
        <tr>
            <td>
                <div class="sig-box">
                    <div class="sig-role">Validado por</div>
                    {% if contract.planner_signature %}
                        <img src="{{ contract.planner_signature.path }}" class="sig-img">
                        <div class="sig-meta">{{ contract.planner_signed_at|date:"d/m/Y H:i" }}<br>IP: {{ contract.planner_ip }}</div>
                    {% else %} <div style="height: 70px;"></div> {% endif %}
                    <div class="sig-line"></div>
                    <div class="sig-name">Cerimonialista</div>
                </div>
            </td>
            <td>
                <div class="sig-box">
                    <div class="sig-role">De Acordo</div>
                    {% if contract.supplier_signature %}
                        <img src="{{ contract.supplier_signature.path }}" class="sig-img">
                        <div class="sig-meta">{{ contract.supplier_signed_at|date:"d/m/Y H:i" }}<br>IP: {{ contract.supplier_ip }}</div>
                    {% else %} <div style="height: 70px;"></div> {% endif %}
                    <div class="sig-line"></div>
                    <div class="sig-name">{{ contract.item.supplier|truncatechars:15 }}</div>
                    <div class="sig-role" style="font-size: 7pt; color: #555;">Fornecedor</div>
                </div>
            </td>
            <td>
                <div class="sig-box">
                    <div class="sig-role">Aprovado por</div>
                    {% if contract.couple_signature %}
                        <img src="{{ contract.couple_signature.path }}" class="sig-img">
                        <div class="sig-meta">{{ contract.couple_signed_at|date:"d/m/Y H:i" }}<br>IP: {{ contract.couple_ip }}</div>
                    {% else %} <div style="height: 70px;"></div> {% endif %}
                    <div class="sig-line"></div>
                    <div class="sig-name">Noivos</div>
                    <div class="sig-role" style="font-size: 7pt; color: #555;">Contratantes</div>
                </div>
            </td>
        </tr>
    </table>

    <div class="footer-audit">
        <table class="footer-table">
            <tr>
                <td class="footer-text">
                    <p>DOCUMENTO ASSINADO DIGITALMENTE VIA SISTEMA SIM, ACEITO.</p>
                    <p>HASH: {{ contract.integrity_hash|default:"(Em processamento)" }}</p>
                    <p>ID: {{ contract.token }} - Página <pdf:pagenumber /> de <pdf:pagecount /></p>
                </td>
                <!-- COLUNA DO QR CODE -->
                <td class="footer-qr">
                    {% if qr_code %}
                        <img src="data:image/png;base64,{{ qr_code }}" style="width: 80px; height: 80px;">
                        <div style="font-size: 6pt; text-align: center; margin-top: 2px;">Validar</div>
                    {% endif %}
                </td>
            </tr>
        </table>
    </div>

</body>
</html>