<!-- MODAL DE ASSINATURA -->
<div class="modal fade" id="signatureModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Coletar Assinatura</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Copie o link abaixo e envie para o cliente, ou insira o e-mail para notificar.</p>
        
        <div class="mb-3">
            <label class="form-label fw-bold">Link Seguro de Assinatura</label>
            <div class="input-group">
                <input type="text" class="form-control" id="modalLinkInput" readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="copyLink()">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>

        <hr>

        <div class="mb-2">
            <label class="form-label fw-bold">Enviar por E-mail (Opcional)</label>
            <input type="email" class="form-control" id="modalEmailInput" placeholder="cliente@email.com">
            <!-- Input hidden para guardar o token CSRF de forma segura -->
            <input type="hidden" id="csrfTokenModal" value="{{ csrf_token }}">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <button type="button" class="btn text-white" style="background-color: #9C27B0;" onclick="sendEmail()">Enviar</button>
      </div>
    </div>
  </div>
</div>

<script>
    // CORREÇÃO DEFINITIVA PARA HTMX:
    // Usamos 'window.' para garantir que a variável seja Global e única.
    // Se ela já existir, apenas ignoramos a recriação.
    
    if (typeof window.currentSignatureUrl === 'undefined') {
        window.currentSignatureUrl = null;
    }

    // Função Global para abrir o modal
    window.openSignatureModal = function(element) {
        // Pega a URL gerada pelo Django no atributo data-url
        window.currentSignatureUrl = element.getAttribute('data-url');
        
        const linkInput = document.getElementById('modalLinkInput');
        // Instancia o modal de forma segura usando Bootstrap 5
        const modalEl = document.getElementById('signatureModal');
        // Se o Bootstrap não estiver carregado ainda, previne erro
        if (typeof bootstrap !== 'undefined') {
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            
            linkInput.value = "Gerando link...";
            document.getElementById('modalEmailInput').value = "";
            
            modal.show();
        } else {
            console.error("Bootstrap JS não carregado.");
            return;
        }

        if (!window.currentSignatureUrl) {
            linkInput.value = "Erro: URL não encontrada.";
            return;
        }

        // Busca o link via AJAX
        fetch(window.currentSignatureUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na rede: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                linkInput.value = data.link;
            })
            .catch(err => {
                console.error("Erro detalhado:", err);
                linkInput.value = "Erro ao gerar link. Tente recarregar a página.";
            });
    }

    window.copyLink = function() {
        const copyText = document.getElementById("modalLinkInput");
        copyText.select();
        copyText.setSelectionRange(0, 99999); // Mobile
        navigator.clipboard.writeText(copyText.value).then(() => {
            alert("Link copiado!");
        });
    }

    window.sendEmail = function() {
        const email = document.getElementById('modalEmailInput').value;
        if(!email) {
            alert("Digite um e-mail.");
            return;
        }

        const formData = new FormData();
        formData.append('email', email);
        
        const csrfInput = document.getElementById('csrfTokenModal');
        // Tenta pegar do input, se falhar tenta cookie
        const csrfToken = csrfInput ? csrfInput.value : getCookie('csrftoken');
        
        fetch(window.currentSignatureUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => {
             if (!response.ok) throw new Error('Erro HTTP: ' + response.status);
             return response.json();
        })
        .then(data => {
            alert("Sucesso: " + data.message);
            const modalEl = document.getElementById('signatureModal');
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) modalInstance.hide();
        })
        .catch(err => {
            console.error("Erro no envio:", err);
            alert("Erro ao enviar. Verifique o console.");
        });
    }
    
    // Auxiliar para pegar cookie CSRF se necessário
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>