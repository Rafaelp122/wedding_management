{% load static %}

{% comment %}
  CSS "Pregui√ßoso" (Lazy-loaded)
  O HTMX vai carregar este CSS no <head> da p√°gina 
  apenas quando esta aba for clicada.
{% endcomment %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light-border.css" />

{# Conte√∫do da aba #}
<div class="card shadow-sm border-0 rounded-4 p-3">
  <h3 class="fs-4 fw-bold text-dark mb-4">Calend√°rio do Casamento</h3>
  
  <div id="calendar"
       data-wedding-id="{{ wedding.id }}"
       style="min-height: 600px; position: relative;">
    
    {# Loading Spinner #}
    <div id="calendar-loading" class="d-flex flex-column align-items-center justify-content-center" 
         style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 1000;">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <p class="mt-3 text-muted fw-medium">Carregando calend√°rio...</p>
    </div>
  </div>
</div>


{% comment %}
  Javascript "Pregui√ßoso" (Lazy-loaded)
  Estes scripts s√≥ ser√£o descarregados e executados 
  pelo navegador quando esta aba for clicada.
{% endcomment %}
<script>
  // Carrega scripts de forma sequencial e confi√°vel
  (function loadSchedulerScripts() {
    const scripts = [
      'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js',
      'https://cdn.jsdelivr.net/npm/@fullcalendar/core/locales/pt-br.global.min.js',
      'https://unpkg.com/@popperjs/core@2',
      'https://unpkg.com/tippy.js@6'
    ];
    
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        // Verifica se o script j√° foi carregado
        const existing = document.querySelector(`script[src="${src}"]`);
        if (existing) {
          if (window.logger) window.logger.log('Script j√° carregado: ' + src);
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => {
          if (window.logger) window.logger.log('‚úÖ Script carregado: ' + src);
          resolve();
        };
        script.onerror = () => {
          if (window.logger) window.logger.error('‚ùå Erro ao carregar: ' + src);
          reject(new Error('Failed to load ' + src));
        };
        document.head.appendChild(script);
      });
    }
    
    // Carrega scripts sequencialmente
    async function loadAllScripts() {
      for (const src of scripts) {
        try {
          await loadScript(src);
        } catch (error) {
          console.error('Erro ao carregar script do scheduler:', error);
        }
      }
      if (window.logger) window.logger.log('üìö Todos os scripts do scheduler foram carregados');
    }
    
    loadAllScripts();
  })();
</script>
