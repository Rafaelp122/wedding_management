<div class="modal-header">
    <h5 class="modal-title">{% if event %}Editar Evento{% else %}Novo Evento{% endif %}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
    
    <form id="event-modal-form"> 
        {% csrf_token %}
        <input type="hidden" name="action" value="modal_save">
        {% if event %}
            <input type="hidden" name="event_id" value="{{ event.id }}">
        {% endif %}
        
        {{ form.event_date }}
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger p-2 small">
                {% for error in form.non_field_errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}

        <div class="mb-3">
            {{ form.title.label_tag }}
            {{ form.title }}
            {% for error in form.title.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
        </div>
        
        <div class="mb-3">
            {{ form.location.label_tag }}
            {{ form.location }}
            {% for error in form.location.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
        </div>
        
        <div class="mb-3">
            {{ form.description.label_tag }}
            {{ form.description }}
            {% for error in form.description.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
        </div>
        
        <div class="mb-3">
            {{ form.event_type.label_tag }}
            {{ form.event_type }}
            {% for error in form.event_type.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
        </div>
        
        <div class="row g-2">
            <div class="col-6 mb-3">
                {{ form.start_time_input.label_tag }}
                {{ form.start_time_input }}
                {% for error in form.start_time_input.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
            </div>
            
            <div class="col-6 mb-3">
                {{ form.end_time_input.label_tag }}
                {{ form.end_time_input }}
                {% for error in form.end_time_input.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
            </div>
        </div>

        <p class="text-muted small">Casamento associado: {{ wedding }}</p>

    </form>
</div>
<div class="modal-footer">
    {% if event %}
        <button type="button" class="btn btn-danger me-auto" id="delete-event-button">
            Excluir
        </button>
    {% endif %}
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
    <button type="submit" class="btn btn-primary" form="event-modal-form">Salvar</button> 
</div>

{# ========================================================== #}
{#      SCRIPT ESPECÍFICO PARA ESTE CONTEÚDO DO MODAL         #}
{# ========================================================== #}
<script>
    // Usa uma função auto-executável para criar um escopo isolado
    (function() {
        console.log("LOG MODAL v2: Script do _event_form_modal_content.html a EXECUTAR.");

        const form = document.getElementById('event-modal-form');
        const deleteButton = document.getElementById('delete-event-button');
        // Obtém o token CSRF (necessário para a função sendCalendarUpdate)
        const csrfTokenInput = form.querySelector('[name=csrfmiddlewaretoken]');
        
        // Verifica se os elementos essenciais existem
        if (!form) {
            console.error("ERRO MODAL v2: Formulário #event-modal-form não encontrado!");
            return; 
        }
        if (!csrfTokenInput) {
             console.error("ERRO MODAL v2: Campo CSRF token não encontrado no formulário!");
            // Não retorna, pois a exclusão pode não precisar dele se usarmos sendCalendarUpdate
        }

        // --- Tratador para o ENVIO do formulário ---
        // Remove listener antigo se existir (segurança extra)
        form.removeEventListener('submit', handleFormSubmit); 
        // Adiciona o novo listener
        form.addEventListener('submit', handleFormSubmit); 
        console.log("LOG MODAL v2: Listener 'submit' adicionado ao formulário.");

        // --- Tratador para o botão EXCLUIR (se existir) ---
        if (deleteButton) {
            // Remove listener antigo se existir
            deleteButton.removeEventListener('click', handleDeleteClick);
            // Adiciona o novo listener
            deleteButton.addEventListener('click', handleDeleteClick);
            console.log("LOG MODAL v2: Listener 'click' adicionado ao botão excluir.");
        } else {
             console.log("LOG MODAL v2: Botão excluir não encontrado (provavelmente é um formulário de criação).");
        }

        // --- Função para lidar com o SUBMIT ---
        function handleFormSubmit(e) {
            e.preventDefault(); // Impede o envio tradicional do formulário
            console.log("LOG MODAL v2: Formulário submetido via JavaScript.");
            
            const formData = new FormData(form);
            const dataToSend = {
                action: 'modal_save',
                event_id: formData.get('event_id') || null, // Pega o ID do evento (se existir)
                // Envia os dados do formulário como um objeto aninhado
                form_data: {}
            };

            // Preenche o objeto form_data com os valores do formulário
            for (const [key, value] of formData.entries()) {
                // Não inclui o csrf token nem a action nos dados do formulário aninhado
                if (key !== 'csrfmiddlewaretoken' && key !== 'action' && key !== 'event_id') {
                    dataToSend.form_data[key] = value;
                }
            }

            console.log("LOG MODAL v2: Chamando sendCalendarUpdate para salvar...");
            // Chama a função global (definida em scheduler_partial.html) para enviar os dados
            if (typeof sendCalendarUpdate === 'function') {
                sendCalendarUpdate(dataToSend); 
            } else {
                 console.error("ERRO MODAL v2: Função global 'sendCalendarUpdate' não encontrada!");
                 alert("Erro crítico: Não foi possível contactar a função de envio. O evento não foi salvo.");
            }
        }

        // --- Função para lidar com o clique em EXCLUIR ---
        function handleDeleteClick(e) {
            e.preventDefault();
            console.log("LOG MODAL v2: Botão excluir clicado.");
            if (confirm('Tem certeza que deseja excluir este evento?')) {
                console.log("LOG MODAL v2: Confirmação de exclusão recebida.");
                const eventIdInput = form.querySelector('[name=event_id]');
                if (!eventIdInput || !eventIdInput.value) {
                     console.error("ERRO MODAL v2: Não foi possível encontrar o ID do evento para exclusão.");
                     alert("Erro: Não foi possível identificar o evento para excluir.");
                     return;
                }
                
                const dataToSend = {
                    action: 'delete',
                    event_id: eventIdInput.value // Obtém o ID do campo oculto
                };

                console.log("LOG MODAL v2: Chamando sendCalendarUpdate para excluir...");
                // Chama a função global para enviar a ação de exclusão
                if (typeof sendCalendarUpdate === 'function') {
                    sendCalendarUpdate(dataToSend);
                } else {
                    console.error("ERRO MODAL v2: Função global 'sendCalendarUpdate' não encontrada!");
                    alert("Erro crítico: Não foi possível contactar a função de envio. O evento não foi excluído.");
                }
            } else {
                 console.log("LOG MODAL v2: Exclusão cancelada pelo utilizador.");
            }
        }

    })(); // Fim da função auto-executável
</script>