{% comment %}
  Template de modal de formulário reutilizável.
  Ele espera 3 variáveis de contexto da view:
  - hx_post_url: A URL para onde o formulário fará o POST.
  - modal_title: O texto para o <h3>.
  - submit_button_text: O texto para o botão de salvar.
{% endcomment %}

<form 
  method="POST"
  hx-post="{{ hx_post_url }}"
  hx-target="#form-modal-container"
  hx-swap="innerHTML"
  id="generic-modal-form"
>
  {% csrf_token %}

  <div class="modal-body p-4 p-md-5 position-relative">

    <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close"></button>

    <h3 class="fw-bold mb-4 text-center">
      {{ modal_title }}
    </h3>

    {% comment %} 
      Os campos do formulário (form) e dados de layout (form_layout_dict, etc.)
      são passados pelas views/mixins
    {% endcomment %}
    {% include "partials/_form_fields.html" with form=form form_layout_dict=form_layout_dict default_col_class=default_col_class form_icons=form_icons %}

    <div class="d-grid gap-2 mt-4">
      <button type="submit" class="btn btn-primary btn-lg">
        {{ submit_button_text }}
      </button>
      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
    </div>

  </div>
</form>

<script>
  (function() {
    // 1. Função de formatação (Escopo local para não conflitar)
    function formatCurrency(value) {
        let numericValue = value.replace(/\D/g, '');
        if (numericValue === '') return '';
        let amount = parseInt(numericValue, 10) / 100;
        return amount.toLocaleString('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // 2. Procura todos os inputs com a classe 'currency-input' que acabaram de carregar
    const currencyInputs = document.querySelectorAll('.currency-input');

    currencyInputs.forEach(input => {
        // A) Evento de Digitação
        input.addEventListener('input', function(e) {
            let oldLength = this.value.length;
            let oldPosition = this.selectionStart;

            this.value = formatCurrency(this.value);

            // Ajuste do cursor
            let newLength = this.value.length;
            let newPosition = oldPosition + (newLength - oldLength);
            this.setSelectionRange(newPosition, newPosition);
        });

        // B) Formatação Inicial (Caso seja Edição e venha do Banco)
        // Se tem valor e não tem "R$", precisa formatar
        if (input.value && !input.value.includes('R$')) {
            // Remove sujeira caso venha com formatação estranha do backend
            let rawValue = input.value.replace(/[^0-9.]/g, ''); 
            let numericValue = parseFloat(rawValue);
            
            if (!isNaN(numericValue)) {
                // Multiplica por 100 porque a função formatCurrency divide por 100
                input.value = formatCurrency((numericValue * 100).toFixed(0));
            }
        }
    });
  })();
</script>
